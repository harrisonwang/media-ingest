name: publish-homebrew

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to publish, e.g. v0.4.0"
        required: true
        type: string

permissions:
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest
    env:
      HOMEBREW_TAP_REPO: ${{ secrets.HOMEBREW_TAP_REPO }}
      HOMEBREW_TAP_GH_TOKEN: ${{ secrets.HOMEBREW_TAP_GH_TOKEN }}
    steps:
      - uses: actions/checkout@v4

      - name: Resolve tag
        id: tag
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "release" ]]; then
            TAG="${{ github.event.release.tag_name }}"
          else
            TAG="${{ github.event.inputs.tag }}"
          fi
          if [[ -z "$TAG" ]]; then
            echo "tag is empty" >&2
            exit 1
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "Resolved tag: $TAG"

      - name: Download release checksums
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p out
          gh release download "${{ steps.tag.outputs.tag }}" \
            -R "${{ github.repository }}" \
            -D out \
            --pattern "SHA256SUMS.txt"
          test -f out/SHA256SUMS.txt

      - name: Generate formula
        shell: bash
        run: |
          set -euo pipefail
          scripts/generate-homebrew-formula.sh \
            --tag "${{ steps.tag.outputs.tag }}" \
            --repo "${{ github.repository }}" \
            --checksums out/SHA256SUMS.txt \
            --output out/mingest.rb
          test -f out/mingest.rb

      - name: Upload formula artifact
        uses: actions/upload-artifact@v4
        with:
          name: homebrew-formula-${{ steps.tag.outputs.tag }}
          path: out/mingest.rb

      - name: Open PR to Homebrew tap
        if: ${{ env.HOMEBREW_TAP_GH_TOKEN != '' }}
        env:
          GH_TOKEN: ${{ env.HOMEBREW_TAP_GH_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          TAP_REPO="${HOMEBREW_TAP_REPO:-mingesthq/homebrew-tap}"
          BRANCH="automation/mingest-${{ steps.tag.outputs.tag }}"

          git clone "https://x-access-token:${HOMEBREW_TAP_GH_TOKEN}@github.com/${TAP_REPO}.git" tap
          mkdir -p tap/Formula
          cp out/mingest.rb tap/Formula/mingest.rb

          cd tap
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          if git diff --quiet -- Formula/mingest.rb; then
            echo "No formula changes to publish"
            exit 0
          fi

          git checkout -B "$BRANCH"
          git add Formula/mingest.rb
          git commit -m "mingest: update formula for ${{ steps.tag.outputs.tag }}"
          git push -f origin "$BRANCH"

          if gh pr list -R "$TAP_REPO" --head "$BRANCH" --json number --jq '.[0].number' | grep -q .; then
            echo "PR already exists for branch $BRANCH"
            exit 0
          fi

          gh pr create \
            -R "$TAP_REPO" \
            --base main \
            --head "$BRANCH" \
            --title "mingest: release ${{ steps.tag.outputs.tag }}" \
            --body "Automated update for mingest release ${{ steps.tag.outputs.tag }}."

      - name: Skip PR (missing token)
        if: ${{ env.HOMEBREW_TAP_GH_TOKEN == '' }}
        run: |
          echo "HOMEBREW_TAP_GH_TOKEN is not configured."
          echo "Formula artifact has been uploaded for manual update."
