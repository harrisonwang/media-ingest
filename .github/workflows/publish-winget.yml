name: publish-winget

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: "Tag to publish, e.g. v0.4.0"
        required: true
        type: string

permissions:
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest
    env:
      WINGET_GH_TOKEN: ${{ secrets.WINGET_GH_TOKEN }}
      WINGET_FORK_REPO: ${{ secrets.WINGET_FORK_REPO }}
    steps:
      - uses: actions/checkout@v4

      - name: Resolve tag
        id: tag
        shell: bash
        run: |
          set -euo pipefail
          if [[ "${{ github.event_name }}" == "release" ]]; then
            TAG="${{ github.event.release.tag_name }}"
          else
            TAG="${{ github.event.inputs.tag }}"
          fi
          if [[ -z "$TAG" ]]; then
            echo "tag is empty" >&2
            exit 1
          fi
          echo "tag=$TAG" >> "$GITHUB_OUTPUT"
          echo "version=${TAG#v}" >> "$GITHUB_OUTPUT"
          echo "Resolved tag: $TAG"

      - name: Download release checksums
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p out
          gh release download "${{ steps.tag.outputs.tag }}" \
            -R "${{ github.repository }}" \
            -D out \
            --pattern "SHA256SUMS.txt"
          test -f out/SHA256SUMS.txt

      - name: Generate winget manifests
        shell: bash
        run: |
          set -euo pipefail
          scripts/generate-winget-manifests.sh \
            --tag "${{ steps.tag.outputs.tag }}" \
            --repo "${{ github.repository }}" \
            --checksums out/SHA256SUMS.txt \
            --output-dir out

      - name: Upload winget manifests artifact
        uses: actions/upload-artifact@v4
        with:
          name: winget-manifests-${{ steps.tag.outputs.version }}
          path: out/manifests

      - name: Open PR to winget-pkgs
        if: ${{ env.WINGET_GH_TOKEN != '' && env.WINGET_FORK_REPO != '' }}
        env:
          GH_TOKEN: ${{ env.WINGET_GH_TOKEN }}
        shell: bash
        run: |
          set -euo pipefail
          VERSION="${{ steps.tag.outputs.version }}"
          BRANCH="automation/mingest-${VERSION}"
          FORK_REPO="${WINGET_FORK_REPO}"
          FORK_OWNER="${FORK_REPO%%/*}"
          TARGET_DIR="manifests/m/Mingest/Mingest/${VERSION}"

          git clone "https://x-access-token:${WINGET_GH_TOKEN}@github.com/${FORK_REPO}.git" winget
          mkdir -p "winget/${TARGET_DIR}"
          cp -f out/${TARGET_DIR}/Mingest.Mingest.yaml "winget/${TARGET_DIR}/"
          cp -f out/${TARGET_DIR}/Mingest.Mingest.installer.yaml "winget/${TARGET_DIR}/"
          cp -f out/${TARGET_DIR}/Mingest.Mingest.locale.en-US.yaml "winget/${TARGET_DIR}/"

          cd winget
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

          if git diff --quiet -- "${TARGET_DIR}"; then
            echo "No winget manifest changes to publish"
            exit 0
          fi

          git checkout -B "$BRANCH"
          git add "${TARGET_DIR}"
          git commit -m "Mingest.Mingest: $VERSION"
          git push -f origin "$BRANCH"

          if gh pr list -R microsoft/winget-pkgs --head "${FORK_OWNER}:${BRANCH}" --json number --jq '.[0].number' | grep -q .; then
            echo "PR already exists for ${FORK_OWNER}:${BRANCH}"
            exit 0
          fi

          gh pr create \
            -R microsoft/winget-pkgs \
            --base master \
            --head "${FORK_OWNER}:${BRANCH}" \
            --title "New version: Mingest.Mingest ${VERSION}" \
            --body "Automated manifest update for mingest release ${{ steps.tag.outputs.tag }}."

      - name: Skip PR (missing token or fork)
        if: ${{ env.WINGET_GH_TOKEN == '' || env.WINGET_FORK_REPO == '' }}
        run: |
          echo "WINGET_GH_TOKEN or WINGET_FORK_REPO is not configured."
          echo "Manifest artifact has been uploaded for manual submission."
